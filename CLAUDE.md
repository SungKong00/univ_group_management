# CLAUDE.md - AI Agent 협업 워크플로우 설정

## 1. Gemini CLI 통합 및 작업 패키지 시스템

### 기본 원칙
- 모든 개발 작업은 `tasks/` 폴더 내 독립적인 작업 패키지에서 수행
- Gemini CLI가 생성한 `SYNTHESIZED_CONTEXT.MD`를 기반으로 개발 수행
- `TASK.MD`에 모든 작업 과정을 실시간으로 기록

## 2. 작업 시작 전 필수 확인 사항

1. **작업 패키지 존재 확인**: `TASK.MD` 파일 존재 여부 확인
2. **컨텍스트 파일 확인**: `SYNTHESIZED_CONTEXT.MD` 파일 존재 여부 확인
3. **미완료 시 안내**: 
   ```
   작업을 시작하기 전에 다음 명령어를 실행해주세요:
   - 새 작업: bash -c './bin/gemini task new "작업 제목"'
   - 컨텍스트 생성: bash -c './bin/gemini task run-context'
   ```

## 3. 개발 워크플로우

### A. 개발
- `SYNTHESIZED_CONTEXT.MD`를 분석하여 구현 계획을 수립하고, 사용자 동의 하에 개발을 진행합니다.
- 모든 주요 활동(파일 생성/수정, 테스트, 에러)은 `TASK.MD`의 "작업 로그"에 기록합니다.
 - `./bin/gemini task run-context` 실행 후에는 디렉터리를 읽지 말고, 출력 메시지의 절대 경로에 있는 `synthesis_input/COMBINED.md` 파일을 우선적으로 읽습니다.

### B. 작업 완료
- 개발 완료 후, `TASK.MD`의 "변경 사항 요약"과 "컨텍스트 업데이트 요청" 섹션을 작성합니다.
- 사용자의 최종 승인을 받으면, 다음 섹션의 '작업 완료 및 컨텍스트 업데이트 핸드오프' 절차를 따릅니다.

## 4. 작업 완료 및 컨텍스트 업데이트 핸드오프

개발 작업이 완료되면, Claude는 다음 절차를 통해 작업을 아카이빙하고, 필요시 후속 조치를 Gemini에게 자동으로 위임합니다.

### 1단계: 작업 아카이빙 실행
Claude는 `TASK.MD` 정리가 완료되면 다음 명령어를 실행합니다.
```bash
bash -c './bin/gemini task complete'
```

### 2단계: 컨텍스트 업데이트 요청 감지 및 자동 위임
`complete_task` 명령어 실행 결과, 터미널에 **"Pending Context Updates Detected!"** 경고가 출력될 경우, Claude는 **사용자 승인을 기다리지 않고 즉시 다음 단계를 수행합니다.**

1.  **요청 내용 추출**: 터미널에 출력된 경고 메시지에서 '컨텍스트 업데이트 요청'의 전체 내용을 정확히 복사합니다.
2.  **Gemini에게 작업 지시**: 다음과 같은 표준 형식의 프롬프트를 생성하여, Gemini 에이전트에게 후속 컨텍스트 수정을 자동으로 지시합니다.

    ```
    Gemini, 다음 컨텍스트 업데이트를 수행해 주세요.

    **업데이트 요청 내용:**
    """
    [복사한 업데이트 요청 내용]
    """
    ```

이 자동화된 핸드오프(Handoff)를 통해, 개발 지식은 누락 없이 에이전트 간의 협업으로 시스템에 반영됩니다.

## 5. 에러 해결 기록 프로토콜 (Frontend/Web 포함)

에러를 해결했다면, Claude는 아래 기록 단계를 반드시 수행하여 컨텍스트를 최신 상태로 유지합니다.

- 아카이브 문서 추가: `context/`에 에러 해결 아카이브 Markdown 생성 또는 갱신
  - 파일명 예: `context/frontend-auth-web-error-archive.md`
  - 포함 항목: 문제 요약, 증상, 원인 분석, 해결 사항(코드/파일 경로 포함), 변경 파일 목록, 검증 체크리스트, 회귀/부작용 고려, 향후 개선 제안
- 변경 이력 업데이트: `context/CHANGELOG.md`에 항목 추가(요약, 링크, 관련 변경 요약)
- 메타데이터 갱신: `.gemini/metadata.json`
  - `last_updated` 갱신
  - `recent_tasks`에 항목 추가(날짜, 제목, 태그, 상태, 비고/노트)
- 필요 시 참조 추가: `context/troubleshooting.md`에 관련 섹션/링크 보강

복잡한 에러가 발생했을 때는, 우선 기존 아카이브에서 유사 사례를 조회하도록 Gemini에게 다음과 같이 지시합니다.

```
Gemini, 에러 아카이브에서 관련 항목을 찾아 요약하고, 현재 증상과의 차이를 정리한 뒤 권장 진단/수정 절차를 제안해 주세요.
```

그 후 진단/수정이 완료되면 위 기록 단계를 수행하여 아카이브를 최신화합니다.

## 5. Gemini CLI 사용 가이드 (For Claude Code)

- **새 작업 시작**: `bash -c './bin/gemini task new "작업 제목"'`
  - 비ASCII(한글 등) 제목은 자동으로 `-task` 슬러그로 대체됩니다.
- **컨텍스트 종합**:
  - 작업 폴더 내부에서: `bash -c './bin/gemini task run-context'`
  - 리포지토리 루트에서 단일 작업만 존재하면 `cd` 없이 바로 실행 가능
- **작업 완료**: `bash -c './bin/gemini task complete'`
  - 완료 시 "컨텍스트 업데이트 요청"이 콘솔에 표시되며, 이를 Gemini에 전달하여 반영 작업을 위임합니다.

## 6. Flutter 개발 환경 설정

### 포트 설정 (중요!)
- **Flutter 웹 실행 포트**: 반드시 **5173번 포트**를 사용해야 함
- **올바른 실행 명령어**: `flutter run -d chrome --web-hostname localhost --web-port 5173`
- **잘못된 명령어**: ~~`--web-port 3000`~~ (작동하지 않음)

## 7. 트러블슈팅

- **EISDIR (디렉터리 읽기 오류)**
  - 원인: `Read(synthesis_input)`처럼 디렉터리를 직접 읽으려 할 때 발생
  - 해결: 콘솔에 표시된 절대 경로의 `synthesis_input/COMBINED.md` 파일을 읽으세요.

- **tasks 경로를 찾지 못함**
  - 원인: 현재 작업 디렉터리와 리포지토리 루트가 다를 수 있음
  - 해결: `pwd`로 현재 위치를 확인하고, 스크립트가 출력한 절대 경로로 `cd` 한 뒤 작업을 진행하세요.

## 6. 사용자 상호작용 가이드

- **작업 시작 시**: 작업 패키지 준비 상태를 확인하고, 필요시 사용자에게 생성을 요청합니다.
- **개발 진행 중**: 주요 단계 완료 시 간단히 보고하고, 문제 발생 시 상황을 공유합니다.
- **작업 완료 시**: 다음과 같이 사용자에게 최종 보고를 합니다.

  ```
  작업이 완료되어 아카이빙을 실행했습니다.

  [만약 경고가 발생했다면 다음 메시지 추가]
  컨텍스트 업데이트 요청이 감지되어, 후속 조치를 Gemini 에이전트에게 자동으로 지시했습니다.
  ```
