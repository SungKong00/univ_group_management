#!/bin/bash
# Post-checkout Hook: Worktree í™˜ê²½ ì„¤ì • ìë™í™”
# .gitignoreëœ ê°œë°œ í•„ìˆ˜ íŒŒì¼ë“¤ì„ ë©”ì¸ worktreeì—ì„œ ìë™ ë³µì‚¬

# ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒì´ ì•„ë‹ˆë©´ ì¢…ë£Œ (íŒŒì¼ ì²´í¬ì•„ì›ƒ ë¬´ì‹œ)
if [ "$3" != "1" ]; then
    exit 0
fi

CURRENT_DIR=$(pwd)
GIT_COMMON_DIR=$(git rev-parse --git-common-dir)

# ë©”ì¸ worktree ê²½ë¡œ ê³„ì‚°
if [ "$GIT_COMMON_DIR" = ".git" ]; then
    MAIN_WORKTREE="$CURRENT_DIR"
    IS_MAIN_WORKTREE=true
else
    MAIN_WORKTREE=$(dirname "$GIT_COMMON_DIR")
    IS_MAIN_WORKTREE=false
fi

# ë©”ì¸ worktreeì—ì„œëŠ” ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
if [ "$IS_MAIN_WORKTREE" = true ]; then
    exit 0
fi

echo "================================================"
echo "ğŸ”§ Worktree í™˜ê²½ ì„¤ì • ìë™í™”"
echo "================================================"
echo "ğŸ“ í˜„ì¬ worktree: $CURRENT_DIR"
echo "ğŸ“ ë©”ì¸ worktree: $MAIN_WORKTREE"
echo ""

# íŒŒì¼ ë³µì‚¬ í•¨ìˆ˜
# ì¸ì: ìƒëŒ€ê²½ë¡œ, ì„¤ëª…, í•„ìˆ˜ì—¬ë¶€(required/optional)
setup_file() {
    local rel_path=$1
    local description=$2
    local is_required=$3

    local current_file="$CURRENT_DIR/$rel_path"
    local main_file="$MAIN_WORKTREE/$rel_path"
    local example_file="$CURRENT_DIR/$rel_path.example"

    # ì´ë¯¸ ìˆìœ¼ë©´ ìŠ¤í‚µ
    if [ -f "$current_file" ]; then
        echo "âœ… $description: ì´ë¯¸ ì¡´ì¬í•¨ (ìŠ¤í‚µ)"
        return 0
    fi

    # ë©”ì¸ worktreeì—ì„œ ë³µì‚¬ ì‹œë„
    if [ -f "$main_file" ]; then
        # ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±
        mkdir -p "$(dirname "$current_file")"
        cp "$main_file" "$current_file"
        echo "âœ… $description: ë©”ì¸ì—ì„œ ë³µì‚¬ ì™„ë£Œ"
        return 0
    fi

    # .example íŒŒì¼ ë³µì‚¬ ì‹œë„
    if [ -f "$example_file" ]; then
        mkdir -p "$(dirname "$current_file")"
        cp "$example_file" "$current_file"
        echo "âš ï¸  $description: .exampleì—ì„œ ë³µì‚¬ë¨ (ì„¤ì • í•„ìš”!)"
        return 1
    fi

    # íŒŒì¼ ì—†ìŒ
    if [ "$is_required" = "required" ]; then
        echo "âŒ $description: íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ (í•„ìˆ˜!)"
        return 2
    else
        echo "â­ï¸  $description: íŒŒì¼ ì—†ìŒ (ì„ íƒì‚¬í•­)"
        return 0
    fi
}

# ê°œë°œ í•„ìˆ˜ íŒŒì¼ë“¤ ì²˜ë¦¬
echo "ğŸ“¦ í™˜ê²½ ì„¤ì • íŒŒì¼ ë³µì‚¬ ì¤‘..."
echo ""

# 1. Frontend .env (í•„ìˆ˜)
setup_file "frontend/.env" "Frontend í™˜ê²½ë³€ìˆ˜" "required"
FRONTEND_ENV_STATUS=$?

# 2. Backend .env (ì„ íƒ)
if [ -d "$CURRENT_DIR/backend" ]; then
    setup_file "backend/.env" "Backend í™˜ê²½ë³€ìˆ˜" "optional"
fi

# 3. Android local.properties (ì„ íƒ)
if [ -d "$CURRENT_DIR/frontend/android" ]; then
    setup_file "frontend/android/local.properties" "Android SDK ê²½ë¡œ" "optional"
fi

# 4. Android key.properties (ì„ íƒ)
if [ -d "$CURRENT_DIR/frontend/android" ]; then
    setup_file "frontend/android/key.properties" "Android ë¦´ë¦¬ì¦ˆ í‚¤" "optional"
fi

echo ""
echo "================================================"

# ìµœì¢… ê²°ê³¼ ìš”ì•½
if [ $FRONTEND_ENV_STATUS -eq 0 ]; then
    echo "âœ… í™˜ê²½ ì„¤ì • ì™„ë£Œ! ë°”ë¡œ ê°œë°œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
elif [ $FRONTEND_ENV_STATUS -eq 1 ]; then
    echo "âš ï¸  í™˜ê²½ ì„¤ì • í•„ìš”!"
    echo ""
    echo "ğŸ“ ë‹¤ìŒ íŒŒì¼ì„ ìˆ˜ì •í•˜ì„¸ìš”:"
    echo "   $CURRENT_DIR/frontend/.env"
    echo ""
    echo "ğŸ’¡ ë˜ëŠ” ë©”ì¸ worktreeì— ë¨¼ì € ì„¤ì •í•˜ë©´ ìë™ ë³µì‚¬ë©ë‹ˆë‹¤:"
    echo "   $MAIN_WORKTREE/frontend/.env"
else
    echo "âŒ í™˜ê²½ ì„¤ì • ì‹¤íŒ¨!"
    echo ""
    echo "ğŸ”§ í•´ê²° ë°©ë²•:"
    echo "   1. ë©”ì¸ worktreeì— .env íŒŒì¼ ìƒì„±:"
    echo "      cd $MAIN_WORKTREE/frontend"
    echo "      cp .env.example .env"
    echo "      # ì‹¤ì œ ê°’ìœ¼ë¡œ ìˆ˜ì •"
    echo ""
    echo "   2. ìƒˆ worktree ì œê±° í›„ ì¬ìƒì„±:"
    echo "      git worktree remove $(basename $CURRENT_DIR)"
    echo "      git worktree add $CURRENT_DIR $(git branch --show-current)"
fi

echo "================================================"
exit 0
