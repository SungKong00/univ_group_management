# 권한 모델 상세 설계 (v2.1 - MVP 단순화)

> 본 문서는 프로젝트의 권한 시스템의 원칙, 구조, 워크플로우를 정의합니다.
> MVP 버전에서는 개인 오버라이드 시스템을 제거하고 단순한 역할 기반 권한으로 운영합니다.

## 1. 핵심 원칙

1.  **워크스페이스 접근**: 그룹의 **멤버**만이 해당 그룹의 워크스페이스에 접근할 수 있다.
2.  **역할 기반 제어 (RBAC)**: 모든 권한은 **역할(Role)**을 통해 사용자에게 부여된다.
3.  **계층적 권한 구조**: 권한은 '그룹 레벨'과 '채널 레벨'의 2단계 계층 구조를 가진다.
4.  **채널 접근 독립성**: 채널 내 활동 권한은 오직 채널별 역할 바인딩으로만 결정된다.

## 2. 권한의 계층 구조

### 2.1. L1: 그룹 레벨 권한 (Group-Level Permissions)

- **목적**: 워크스페이스 전체를 관리하기 위한 상위 레벨 권한입니다.
- **주요 권한** (MVP 단순화):
    - `GROUP_MANAGE`: 그룹 정보 수정, 그룹 삭제
    - `ADMIN_MANAGE`: 멤버 관리 + 역할 관리 통합 (멤버 역할 변경, 강제 탈퇴, 커스텀 역할 CRUD, 가입 신청 승인/반려)
    - `CHANNEL_MANAGE`: 채널 생성/삭제/설정, 채널별 역할 바인딩 설정 (**중요**: 채널 내 활동 권한과는 별개)
    - `RECRUITMENT_MANAGE`: 모집 공고 관리 통합
    - `WORKSPACE_ACCESS`: 워크스페이스 기본 접근 (일반 멤버용)
- **부여 방식**: 그룹장(`OWNER`) 또는 `ADMIN_MANAGE` 권한을 가진 사용자가 역할에 이 권한들을 부여합니다.

### 2.2. L2: 채널 레벨 권한 (Channel-Level Permissions)

- **목적**: 각 채널 내부에서의 활동(읽기, 쓰기 등)을 제어하기 위한 세분화된 권한입니다.
- **주요 권한** (MVP 단순화):
    - `CHANNEL_VIEW`: 채널 존재 확인 및 기본 정보 조회
    - `POST_READ`: 게시글 읽기
    - `POST_WRITE`: 게시글 작성
    - `COMMENT_WRITE`: 댓글 작성
    - `FILE_UPLOAD`: 파일 업로드
- **부여 방식**: `CHANNEL_MANAGE` 권한을 가진 사용자가 **각 채널별로** 어떤 역할이 어떤 채널 레벨 권한을 가질지 바인딩합니다.
- **접근 규칙**: 채널별 바인딩이 없으면 접근 불가 (폴백 없음)

## 3. 역할 시스템 (Role System)

### 3.1. 시스템 기본 역할

- **`OWNER` (그룹장)**: 그룹 내 모든 권한을 가진 최상위 관리자입니다.
- **`ADVISOR` (지도교수)**: MVP에서는 OWNER와 동일한 권한을 가집니다. (향후 정책적 제한 적용 예정)
- **`MEMBER` (일반 멤버)**: 그룹 가입 시 기본적으로 부여되는 역할로, `WORKSPACE_ACCESS` 권한만 가집니다.

### 3.2. 커스텀 역할 (Custom Roles)

`멤버 관리` 또는 `역할 관리` 권한을 가진 사용자는 커스텀 역할을 자유롭게 생성할 수 있습니다.

- **목적 1: 멤버 분류 (Grouping)**
    - 특정 권한 없이 멤버들을 논리적으로 그룹핑하기 위해 사용됩니다.
    - **예시**: '1학년', '2학년' 역할을 생성하여 학생들에게 부여. 이 역할들은 기본적으로 '일반 멤버'와 동일한 권한을 가집니다.

- **목적 2: 권한 위임 (Delegation)**
    - 특정 그룹 레벨 권한을 위임하여 중간 관리자를 지정하기 위해 사용됩니다.
    - **예시**: '운영진' 역할을 만들고, `채널 관리`와 `모집 관리` 권한을 부여하여 그룹장 대신 채널과 멤버 모집을 관리하게 할 수 있습니다.

## 4. 권한 관리 워크플로우 예시

> **시나리오**: "과제 토론방" 채널을 만들어, 1학년은 글을 읽기만 하고 2학년은 읽고 쓸 수 있게 만들고 싶다.

1.  **`[멤버 관리자]` 역할 생성**:
    - `멤버 관리` 권한을 가진 사용자가 관리 페이지에서 '1학년'과 '2학년'이라는 커스텀 역할을 생성합니다.
    - 각 학년 멤버들에게 해당 역할을 부여합니다.

2.  **`[채널 관리자]` 채널 생성**:
    - `채널 관리` 권한을 가진 사용자가 "과제 토론방"이라는 새 채널을 생성합니다.

3.  **`[채널 관리자]` 채널 권한 설정**:
    - "과제 토론방" 채널의 권한 설정 메뉴로 들어갑니다.
    - **읽기 권한** 설정에 `1학년`, `2학년` 역할을 모두 추가합니다.
    - **쓰기 권한** 설정에는 `2학년` 역할만 추가합니다.

4.  **`[사용자]` 최종 권한 적용**:
    - '1학년' 역할을 가진 멤버는 "과제 토론방"에서 글을 읽을 수는 있지만, 글쓰기 버튼이 비활성화됩니다.
    - '2학년' 역할을 가진 멤버는 글을 읽고 쓰는 것이 모두 가능합니다.

---

## 5. 기술 구현 상세

### 5.1. 전역 역할 (GlobalRole)
- **목적**: 시스템 전역에서의 사용자 신분/권한
- **값**: `STUDENT`, `PROFESSOR`, `ADMIN`
- **JWT**: `auth` 클레임에 `ROLE_STUDENT|ROLE_PROFESSOR|ROLE_ADMIN` 형태로 저장

### 5.2. 권한 카탈로그 (Permission Catalog)
- **그룹 레벨 권한 키**: `GROUP_MANAGE`, `MEMBER_MANAGE`, `ROLE_MANAGE`, `CHANNEL_MANAGE`, `RECRUITMENT_MANAGE` 등
- **채널 레벨 권한 키**: `CHANNEL_VIEW`, `POST_READ`, `POST_WRITE`, `COMMENT_WRITE`, `FILE_UPLOAD` 등
- 모든 권한 키는 상수(Enum)로 관리됩니다.

### 5.3. 인가 구현 표준
- 컨트롤러: `@PreAuthorize("hasPermission(#groupId, 'GROUP', '<PERMISSION>')")`
- Evaluator 규칙:
  1. 전역 `ADMIN` 즉시 허용
  2. `(userId, groupId)`의 멤버십 존재 확인
  3. **채널 레벨 권한의 경우**: 채널에 바인딩된 역할 권한 우선 확인
  4. **그룹 레벨 권한의 경우**: 그룹 역할의 권한 세트 집계
  5. 요청 권한 포함 여부 검사

### 5.4. 성능/운영
- **캐싱**: `(groupId, userId) → permission set` 결과를 30~60초 캐싱하며, 역할/권한 변경 시 관련 캐시를 무효화합니다.
- **로깅**: 권한 거부 발생 시 사유(누가/어디서/무슨 권한)를 구조화하여 로깅합니다.

## 6. MVP 제외 사항

### 6.1. 개인 권한 오버라이드 시스템
- **제외 이유**: 복잡성 증가, MVP 핵심 기능과의 우선순위
- **대안**: 역할 기반 시스템에 집중, 필요시 임시 역할 생성으로 대체
- **향후 계획**: 서비스 안정화 후 추가 검토

### 6.2. 채널 권한 폴백 시스템
- **제외 이유**: 채널 관리 권한과 채널 접근 권한의 명확한 분리
- **원칙**: 채널별 바인딩이 없으면 접근 불가 (명시적 권한 부여 필요)
- **예시**: 그룹장이 채널을 생성했어도 자신의 역할을 해당 채널에 바인딩하지 않으면 채널 내용을 볼 수 없음

### 6.3. 단순화된 권한 구조
- **통합된 권한**: `ADMIN_MANAGE` (멤버 관리 + 역할 관리), `RECRUITMENT_MANAGE` (모집 관련 통합)
- **단순한 Set 기반 관리**: 복잡한 비트마스크 로직 제거
- **명확한 역할**: OWNER, ADVISOR, MEMBER의 단순한 3단계 시스템