# 권한 모델 및 카탈로그

본 문서는 권한 체계의 기준을 정의합니다. 전역 역할(GlobalRole), 그룹 역할(GroupRole), 권한 카탈로그(GroupPermission), 시스템 역할 프리셋을 표준화합니다.

## 1. 전역 역할 (GlobalRole)
- 목적: 시스템 전역에서의 사용자 신분/권한
- 값: `STUDENT`, `PROFESSOR`, `ADMIN`
- JWT: `auth` 클레임에 `ROLE_STUDENT|ROLE_PROFESSOR|ROLE_ADMIN` 형태로 저장
- 사용처: 전역 관리 기능 접근, 진단/감사, (정책에 따라) 그룹 권한 검사 우회(ADMIN)

## 2. 그룹 역할 (GroupRole)
- 목적: 그룹 내에서의 역할/권한 부여 단위
- 시스템 역할(기본 제공):
  - `OWNER` (그룹장)
  - `ADVISOR` (지도교수)
  - `MEMBER`
- 커스텀 역할: 그룹장이 생성/수정/삭제 가능 (권한: `ROLE_MANAGE` 또는 OWNER)

## 3. 권한 카탈로그 (GroupPermission)
아래 권한 키를 기준으로 인가를 수행합니다.

- 그룹 관리: `GROUP_MANAGE`
- 멤버 관리: `MEMBER_VIEW`, `MEMBER_APPROVE`, `MEMBER_KICK`
- 역할 관리: `ROLE_MANAGE`
- 채널: `CHANNEL_READ`, `CHANNEL_WRITE`
- 게시글: `POST_CREATE`, `POST_UPDATE_OWN`, `POST_DELETE_OWN`, `POST_DELETE_ANY`
- 모집 공고: `RECRUITMENT_CREATE`, `RECRUITMENT_UPDATE`, `RECRUITMENT_DELETE`

필요 시 도메인 확장에 따라 세분화 권한을 추가합니다. 권한 키는 상수(Enum)로 관리합니다.

## 4. 시스템 역할 프리셋 (권장 매핑)

- OWNER: 모든 권한 허용
- ADVISOR: OWNER와 동일하되, OWNER/ADVISOR 인사권 제한(정책으로 예외 처리 가능)
- MEMBER: `CHANNEL_READ`, `POST_CREATE`, `POST_UPDATE_OWN`, `POST_DELETE_OWN`

정책 예외(예: ADVISOR의 인사권 제한)는 `PermissionEvaluator` 내부 로직으로 처리합니다.

## 5. 인가 구현 표준
- 컨트롤러: `@PreAuthorize("hasPermission(#groupId, 'GROUP', '<PERMISSION>')")`
- 선택적 헬퍼: `@PreAuthorize("@security.hasGroupPerm(#groupId, '<PERMISSION>')")`
- Evaluator 규칙:
  1. 전역 `ADMIN` 즉시 허용
  2. `(userId, groupId)`의 멤버십 존재 확인
  3. 역할의 권한 세트 집계(시스템=프리셋, 커스텀=DB 조회)
  4. 요청 권한 포함 여부 검사

## 6. 성능/운영
- 캐싱: `(groupId, userId) → permission set` 30~60초 캐싱, 변경 시 무효화
- 로깅: 거부 사유(누가/어디서/무슨 권한) 구조화 로깅

## 7. 마이그레이션 가이드 (요약)
- `User.role` → `User.globalRole`로 리네이밍 및 값 정렬(`STUDENT|PROFESSOR|ADMIN`)
- 그룹 스키마 도입: `Group`, `GroupMember(userId, groupId, roleId)`, `GroupRole`, `GroupRolePermission`
- 초기 데이터: 그룹 생성 시 `OWNER/ADVISOR/MEMBER` 역할 자동 생성 및 권한 프리셋 주입

