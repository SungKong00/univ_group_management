# 인증 / 인가

## ## 2. 인증 및 인가 전략 (Authentication & Authorization)

### ### 1. 인증(Authentication) 흐름 설계: "당신은 누구십니까?"

우리는 Google 소셜 로그인을 사용하기로 했습니다. 사용자가 앱에 처음 접속해서 우리 서비스의 고유 인증 토큰(JWT)을 발급받기까지의 흐름을 구체적으로 설계합니다.

- **전체 흐름:**
    1. **[프론트엔드]** 사용자가 Flutter 앱에서 'Google로 로그인' 버튼을 클릭하고, 구글 인증을 완료하면 **'Google 인증 토큰'**을 발급받습니다.
    2. **[프론트엔드 → 백엔드]** Flutter 앱은 이 'Google 인증 토큰'을 백엔드 API(`POST /api/auth/google`)로 전달합니다.
    3. **[백엔드]** Spring Boot 서버는 전달받은 토큰이 유효한지 Google 서버에 직접 확인합니다.
    4. **[백엔드]**
        - **최초 사용자일 경우:** Google로부터 받은 이메일 등의 정보로 우리 DB에 새로운 `User`를 생성합니다.
        - **기존 사용자일 경우:** DB에서 해당 유저 정보를 조회합니다.
    5. **[백엔드 → 프론트엔드]** 백엔드는 해당 사용자를 식별하는 **우리 서비스 전용 JWT(Access Token)**를 생성하여 프론트엔드에 전달합니다.
    6. **[프론트엔드]** 이후 모든 API 요청 시, Flutter 앱은 발급받은 JWT를 HTTP 헤더(`Authorization: Bearer <JWT>`)에 포함하여 보냅니다. 백엔드는 이 JWT를 통해 사용자를 식별합니다.

---

### ### 2. 인가(Authorization) 전략 설계: "이 작업을 수행할 권한이 있습니까?"

로그인한 사용자가 특정 그룹의 공지를 삭제하는 등, 권한이 필요한 작업을 요청했을 때 이를 어떻게 검증할지 설계합니다.

### **A. JWT Payload(내용물) 정의**

우리 서비스 전용 JWT에는 사용자를 식별하고 권한을 검증하는 데 필요한 최소한의 정보를 담습니다.

- **`sub` (Subject):** 사용자의 고유 ID (`userId`)
- **`email`**: 사용자 이메일
- **`auth`**: 시스템 전역 역할 (예: `ROLE_STUDENT`, `ROLE_PROFESSOR`)
- **`exp` (Expiration Time):** 토큰 만료 시간

### **B. 토큰 유효 기간 정책**

- **Access Token:** MVP의 단순성을 위해, **Access Token의 유효 기간을 24시간 또는 7일** 정도로 비교적 길게 설정합니다.
- **Refresh Token:** 사용자가 다시 로그인하는 번거로움을 줄여주는 Refresh Token은 구현 복잡도를 높이므로, **MVP 범위에서는 제외**합니다.

### **C. 권한 검사 구현 방식**

Spring Security의 강력한 **메서드 시큐리티(Method Security)** 기능을 사용하여, 각 API 컨트롤러 메서드에 진입하기 전에 권한을 선언적으로 검사합니다.

- **사용 기술:** `@PreAuthorize` 어노테이션
- **동작 방식:** 특정 API가 호출되면, 본격적인 로직 실행 전에 `@PreAuthorize`에 정의된 조건을 먼저 검사하여 통과할 경우에만 메서드를 실행시킵니다.
- **예시: 그룹 멤버 강제 탈퇴 API**
    - **요구사항:** 오직 '그룹장'이거나 '멤버 관리' 권한이 있는 역할만 이 기능을 사용할 수 있어야 합니다.
    - **구현 코드 (Controller)**Kotlin
        
        `@PreAuthorize("@groupPermissionEvaluator.hasPermission(#groupId, 'MEMBER_KICK')")
        @DeleteMapping("/groups/{groupId}/members/{memberId}")
        fun kickMember(
            @PathVariable groupId: Long,
            @PathVariable memberId: Long
        ) {
            // 이 코드는 권한 검사를 통과한 사용자만 실행할 수 있습니다.
            memberService.kick(groupId, memberId)
        }`
        
    - **설명:** 위 코드에서 `@groupPermissionEvaluator`는 우리가 직접 만들 커스텀 권한 검사 서비스입니다. 이 서비스는 현재 로그인한 사용자가 해당 그룹(`groupId`)에 대해 `'MEMBER_KICK'` 권한을 가지고 있는지 DB를 확인하고, 결과가 `true`일 때만 `kickMember` 메서드를 실행시켜 줍니다.