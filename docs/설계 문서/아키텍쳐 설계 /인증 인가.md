# 인증 / 인가

## 2. 인증 및 인가 전략 (Authentication & Authorization)

### 1) 인증(Authentication) 흐름: "당신은 누구십니까?"

Google 소셜 로그인을 사용합니다. 사용자가 우리 서비스의 JWT(Access Token)를 발급받기까지의 흐름은 다음과 같습니다.

- 전체 흐름:
  1. [프론트엔드] Flutter에서 Google 로그인 후 **Google ID Token** 획득
  2. [프론트엔드 → 백엔드] `POST /api/auth/google`로 토큰 전달
  3. [백엔드] Google 서버에 토큰 유효성 검증
  4. [백엔드] 최초 사용자면 `User` 생성, 기존이면 조회
  5. [백엔드 → 프론트엔드] 우리 서비스용 **JWT(Access Token)** 발급
  6. [프론트엔드] 이후 요청에 `Authorization: Bearer <JWT>` 포함

—

### 2) 인가(Authorization) 전략: "이 작업을 수행할 권한이 있습니까?"

요구명세서에 따라 전역 역할(Global Role)과 그룹 단위 권한(Group-scoped Permission)을 분리합니다. Spring Security의 메서드 시큐리티를 **PermissionEvaluator** 기반으로 표준화하여 사용합니다.

#### A. 권한 모델 개요
- 전역 역할(Global): 사용자의 시스템 전역 신분/권한
  - 예: `ROLE_STUDENT`, `ROLE_PROFESSOR`, `ROLE_ADMIN`
  - JWT `auth` 클레임에만 저장 (변동이 적고 단순)
- 그룹 단위 권한: 그룹별 역할/권한(그룹장/지도교수/멤버/커스텀 역할)
  - 요청 시 DB로 평가 (변동이 잦음, 수가 많음 → JWT에 포함하지 않음)

#### B. JWT Payload 정의
- `sub`: 사용자 고유 ID (userId)
- `email`: 사용자 이메일
- `auth`: 전역 권한 스트링 (예: `ROLE_STUDENT`, `ROLE_PROFESSOR`, `ROLE_ADMIN`)
- `exp`: 만료 시간

토큰 정책은 Access Token만 사용(24시간~7일), Refresh Token은 MVP 범위에서 제외합니다.

#### C. 권한 검사 구현 방식 (권장)
- 기술: `@PreAuthorize` + Spring `PermissionEvaluator`
- 표준 형태:
  ```
  @PreAuthorize("hasPermission(#groupId, 'GROUP', 'MEMBER_KICK')")
  ```
  - 인자: `(targetId, targetType, permission)`
  - `targetType`은 도메인 문자열 기준(예: `GROUP`)

- 선택적 헬퍼(가독성 보강): 커스텀 Expression Root Bean 제공
  ```
  @PreAuthorize("@security.hasGroupPerm(#groupId, 'MEMBER_KICK')")
  ```
  내부적으로 `hasPermission(#groupId, 'GROUP', 'MEMBER_KICK')`로 위임

#### D. 예시: 그룹 멤버 강제 탈퇴 API
```kotlin
@PreAuthorize("hasPermission(#groupId, 'GROUP', 'MEMBER_KICK')")
@DeleteMapping("/groups/{groupId}/members/{memberId}")
fun kickMember(
    @PathVariable groupId: Long,
    @PathVariable memberId: Long
) {
    memberService.kick(groupId, memberId)
}
```

#### E. PermissionEvaluator 동작 규칙
- 글로벌 `ADMIN`이면 허용
- `(userId, groupId)`로 `GroupMember` 조회
  - 멤버가 아니면 거부
  - 멤버의 `GroupRole` → 권한 세트 집계
    - 시스템 역할(OWNER/ADVISOR/MEMBER)은 프리셋
    - 커스텀 역할은 `GroupRolePermission`에서 조회
- 요청 권한이 세트에 존재하면 허용

#### F. 캐싱/로깅
- `(groupId, userId) → permission set`을 30~60초 캐싱 (권한 변경 시 무효화)
- 중앙 Evaluator에서 거부 사유 로그 및 메트릭 수집

—

### 부록) 전역/그룹 역할 정의는 별도 문서 참조
- 전역 역할, 그룹 권한 카탈로그, 시스템 역할 프리셋: "권한 모델 및 카탈로그" 문서 참고
