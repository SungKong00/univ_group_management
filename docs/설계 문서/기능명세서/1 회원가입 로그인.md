# 1. 회원가입 / 로그인 (v2 - 코드 기준)

**1. 개요 (Overview)**

- **1.1. 기능 정의:** 사용자가 Google 소셜 계정을 통해 간편하게 인증하고, 신규 사용자일 경우 온보딩 절차를 통해 역할(학생/교수)과 추가 정보를 입력합니다. 학교 이메일 인증을 통해 재학생/교직원임을 증명하며, 교수 역할은 관리자의 승인을 거칩니다.
- **1.2. 목표 및 기대 효과:** 사용자가 자신의 역할에 맞는 명확한 절차에 따라 2분 내에 간편하고 안전하게 가입을 완료하게 한다.
- **1.3. 범위 (Scope):** Google 소셜 로그인, 신규 사용자 온보딩(역할, 추가 정보 입력), 학교 이메일 인증, 교수 역할 신청 및 관리자 승인.

**2. 사용자 요구사항 (Requirements)**

- **2.1. 주요 페르소나:** 신규 가입 학생, 신규 가입 교수/교직원.
- **2.2. 사용자 스토리:**
    - (학생) "나는 Google 계정으로 간편하게 가입하고, 학교 이메일 인증까지 빠르게 마치고 싶다."
    - (교수) "나는 간편히 가입하되, 내 역할이 안전하게 인증받기를 원한다. 승인 전까지 일부 기능 사용이 제한되더라도 이해할 수 있다."
- **2.3. 기능 요구사항:** Google OAuth2 사용, 역할(학생/교수) 선택 필수, 실명/닉네임/학과/학번 입력 필수, 닉네임 중복 불가, 학교 이메일 인증 코드(6자리, 5분 유효) 발송, 교수 역할 신청 시 '승인 대기' 상태 부여 및 관리자 알림.

**3. UX/UI 및 플로우 (코드 기반)**

- **핵심 철학:** `하나의 화면엔, 하나의 목표만`. 사용자가 각 단계의 목표에만 완벽하게 집중하도록 전체 화면을 사용하는 페이지로 구성한다.
- **3.1. 사용자 플로우차트 (Flowchart)**
    1. **시작 (Google 인증):** 사용자가 프론트엔드에서 [Google 계정으로 계속하기]를 선택하여 Google 인증을 완료하고, 백엔드로 `id_token`을 전송한다.
    2. **백엔드 처리:** 백엔드는 토큰을 검증하고 사용자를 식별한다. 신규 사용자일 경우 `firstLogin: true`를, 기존 사용자일 경우 `firstLogin: false`와 함께 JWT 토큰을 응답한다.
    3. **온보딩 (화면: 프로필 완성):** `firstLogin: true`인 경우, 사용자는 온보딩 화면으로 이동하여 역할(학생/교수), 실명, 닉네임, 학과, 학번 등 필수 정보를 입력하고 제출한다. (`POST /api/users`)
    4. **학교 이메일 인증:** 온보딩 과정 또는 마이페이지에서 학교 이메일 인증을 진행할 수 있다. 인증 코드를 받고, 검증한다.
    5. **역할 신청 (교수):** 온보딩 시 '교수' 역할을 선택한 경우, 자동으로 역할 신청이 제출되며 관리자 승인 대기 상태가 된다. (`POST /api/roles/apply`)
    6. **완료:** 가입/로그인 절차가 완료되고 사용자는 메인 화면으로 이동한다. 교수 신청자는 '승인 대기' 상태 배너를 보게 된다.

**4. 예외 처리 및 제약사항 (Edge Cases & Constraints)**

- **가입 중단:** 온보딩 절차 중 이탈 시 진행 상태는 저장되지 않음.
- **닉네임 중복:** 중복 시 "이미 사용 중인 닉네임입니다." 에러 즉시 표시.
- **인증 코드 오류:** 코드 불일치 또는 시간 만료 시 적절한 에러 메시지 표시.
- **교수 인증 반려:** 반려 시 사용자에게 알림을 보내고 권한은 '학생'으로 자동 변경.

**5. 성공 지표 (Success Metrics)**

- **가입 전환율:** [Google 로그인 시작] 대비 [온보딩 완료] 비율.
- **평균 가입 소요 시간:** Google 로그인부터 온보딩 완료까지의 평균 시간.

---

### 6. API 명세 (코드 기준)

| 기능 | HTTP Method | URI | Request Body | Response Body | 설명 |
| --- | --- | --- | --- | --- | --- |
| **Google 로그인/가입** | `POST` | `/api/auth/google/callback` | `{ "id_token": "..." }` | `{ "accessToken": "...", "firstLogin": bool, ... }` | Google ID 토큰으로 로그인/가입 처리. 신규 유저 여부 반환. |
| **온보딩 정보 제출** | `POST` | `/api/users` | `{ "name": "...", "nickname": "...", "role": "...", ... }` | `User` 객체 | 신규 유저가 추가 정보를 제출하여 가입 완료. |
| **닉네임 중복 확인** | `GET` | `/api/users/nickname-check?nickname=...` | | `{ "available": bool, ... }` | 닉네임 중복 여부 확인. |
| **학교 이메일 인증코드 발송** | `POST` | `/api/email/verification/send` | `{ "email": "..." }` | `{ "success": true }` | 학교 이메일로 인증 코드 발송. |
| **학교 이메일 인증코드 확인** | `POST` | `/api/email/verification/verify` | `{ "email": "...", "code": "..." }` | `{ "success": true }` | 인증 코드 검증. |
| **역할 신청 (교수 등)** | `POST` | `/api/roles/apply` | `{ "role": "PROFESSOR" }` | `{ "success": true }` | 특정 역할(예: 교수)을 신청하고 승인 대기. |

### 7. DTO (Data Transfer Object) 정의 (코드 기준)

- **GoogleLoginRequest**
    - `id_token: String`
- **AuthResponse**
    - `accessToken: String`
    - `firstLogin: Boolean`
    - `user: UserDto`
- **OnboardingRequest**
    - `name: String`
    - `nickname: String`
    - `dept: String` (Optional)
    - `studentNo: String` (Optional)
    - `schoolEmail: String`
    - `role: String` (e.g., "STUDENT", "PROFESSOR")
- **NicknameCheckResponse**
    - `available: Boolean`
    - `suggestions: List<String>`
- **EmailVerificationRequest**
    - `email: String`
- **EmailVerificationConfirmRequest**
    - `email: String`
    - `code: String`
- **RoleApplyRequest**
    - `role: String`