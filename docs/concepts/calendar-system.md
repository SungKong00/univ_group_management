# 캘린더 시스템 통합 개념 설계 (v1.3)

**최종 업데이트: 2025-10-07**

## 1. 개요 (Overview)

대학 내 구성원들의 학업, 개인, 그룹 활동을 효율적으로 관리하기 위한 통합 일정 관리 시스템입니다. 시스템은 크게 **개인 영역**과 **그룹 영역**으로 나뉘며, 각 영역의 일정이 유기적으로 연동됩니다.

-   **개인 영역**: 사용자의 고정된 **시간표(Timetable)**와 유동적인 **캘린더(Calendar)**를 분리하여 관리합니다.
-   **그룹 영역**: 특정 그룹 내에서 공유하고 협업하는 **그룹 캘린더**와 **장소 캘린더**를 제공합니다.

## 2. 핵심 설계 원칙 (Core Design Principles)

| ID | 결정사항 | 핵심 내용 |
| :--- | :--- | :--- |
| **DD-CAL-001** | **권한 통합** | 캘린더 관련 권한(`CALENDAR_MANAGE` 등)은 기존 그룹 RBAC 시스템에 완전히 통합합니다. |
| **DD-CAL-002** | **반복 일정 저장** | 반복 일정은 생성 시점에 모든 개별 인스턴스를 DB에 명시적으로 저장하여, 조회 성능과 개별 수정의 용이성을 확보합니다. |
| **DD-CAL-003** | **반복 일정 예외** | 반복 일정 중 특정 날짜만 수정/취소될 경우, `EventException`이라는 별도 테이블에서 관리하여 원본 패턴을 보존합니다. |
| **DD-CAL-004** | **참여자 관리** | 일정 참여자 정보는 `EventParticipant`라는 독립된 테이블에서 관리하여, 참여 상태(참여/불참) 및 사유를 상세히 추적합니다. |
| **DD-CAL-005** | **시간표 데이터 정규화** | 대학 강의 정보는 `Course`(과목)와 `CourseTimetable`(분반)으로 분리하여, 동일 과목의 여러 분반을 효율적으로 관리합니다. |
| **DD-CAL-006** | **장소 예약 통합** | 장소 예약(`PlaceReservation`)은 반드시 그룹 일정(`GroupEvent`)에 종속되는 1:1 관계로 설계하여, 일정 없는 예약을 방지하고 데이터 무결성을 보장합니다. |
| **DD-CAL-007** | **최적 시간 추천** | MVP 단계에서는 참여 가능 인원이 가장 많은 단순하고 직관적인 알고리즘을 채택합니다. |
| **DD-CAL-008** | **동시성 제어** | 장소 예약과 같이 동시 요청 충돌 가능성이 있는 경우, `@Version`을 이용한 **낙관적 락(Optimistic Lock)**을 기본 전략으로 사용합니다. |

## 3. 주요 기능 및 구성요소 (상세)

### 3.1. 개인 영역: 시간표와 캘린더

#### 3.1.1. 시간표 (Timetable): 고정된 주간 반복 일정 관리
-   **목적**: 주간 단위의 고정적이고 반복적인 일정을 한눈에 파악하고, 다른 기능(최적 시간 추천 등)의 기반 데이터로 활용하기 위함입니다.
-   **핵심 특징**:
    -   **뷰**: 오직 **주간(Weekly) 뷰**만 제공하여, 한 주의 고정된 스케줄을 직관적으로 보여줍니다.
    -   **관리 대상**: 수강하는 강의, 아르바이트, 동아리 정기 회의 등 예측 가능하고 잘 변하지 않는 일정을 등록합니다.
    -   **데이터 소스**:
        1.  **학교 강의**: 관리자가 등록한 `Course` 목록에서 사용자가 수강하는 `CourseTimetable`(분반)을 선택하여 추가합니다.
        2.  **개인 반복 일정**: 사용자가 직접 요일, 시간, 제목 등을 입력하여 `PersonalSchedule`을 생성합니다.
    -   **시스템 연동**: 여기에 등록된 시간 정보는 그룹 일정 생성 시 **'최적 시간 추천' 기능을 위한 핵심 분석 데이터**로 사용되어, 사용자의 참석 불가능한 시간을 미리 제외하는 역할을 합니다.

#### 3.1.2. 캘린더 (Calendar): 모든 일정을 통합하는 개인 허브
-   **목적**: 일회성 약속, 그룹 활동 등 모든 확정된 일정을 월/주/일 단위로 통합 관리하는 사용자의 메인 캘린더입니다.
-   **핵심 특징**:
    -   **뷰**: **월(Month), 주(Week), 일(Day)** 등 표준적인 캘린더 뷰를 제공합니다.
    -   **관리 대상**:
        1.  **개인 이벤트**: 사용자가 직접 생성하는 일회성 또는 특정 기간의 이벤트입니다. (예: 병원 예약, 친구와의 약속, 여행 계획)
        2.  **참여 그룹 일정**: 사용자가 그룹 캘린더에서 **'참여(ACCEPTED)' 의사를 밝힌 모든 그룹 일정**이 이 캘린더에 자동으로 동기화되어 표시됩니다.
    -   **상호작용**: 그룹 캘린더에서 초대받은 일정에 '참여'를 누르면, 해당 일정이 개인 캘린더에 즉시 반영됩니다. 이를 통해 사용자는 자신의 모든 확정된 스케줄을 이곳에서 한눈에 확인할 수 있습니다.

### 3.2. 그룹 캘린더 (Group Calendar)

그룹의 멤버라면 누구나 별도의 조회 권한 없이 그룹 캘린더를 볼 수 있습니다.

-   **일정 구분**:
    -   **공식 일정 (Official Event)**: `CALENDAR_MANAGE` 권한 보유자만 생성/수정/삭제 가능.
    -   **비공식 일정 (Unofficial Event)**: 모든 그룹 멤버가 자유롭게 생성 가능. 단, 수정 및 삭제는 **작성자 본인** 또는 **`CALENDAR_MANAGE` 권한 보유자**만 가능합니다.

-   **공식/비공식 일정의 기능 범위**:

    | 기능 | 공식 일정 | 비공식 일정 |
    |------|----------|------------|
    | 일정 유형 | General/Targeted/RSVP | General만 |
    | 장소 예약 | 가능 | 가능 |
    | 채널 연동 | 가능 | 가능 |

-   **공식 일정의 3가지 유형 (상세 로직)**:
    1.  **일반 공지형 (General)**:
        -   **로직**: 단순 정보성 일정으로, 생성 시 캘린더에 표시되는 것 외에 별도의 멤버 상호작용이나 자동화 로직은 없습니다. 그룹의 중요 마일스톤을 기록하는 용도로 사용됩니다.
    2.  **대상 지정형 (Targeted)**:
        -   **로직**: 생성 시점에 지정된 조건(예: 1학년, 운영진 역할)에 맞는 멤버 목록이 확정되어 `EventParticipant` 테이블에 `PENDING` 상태로 자동 생성됩니다. **생성 이후 멤버의 역할이 변경되어도 초대 대상은 바뀌지 않습니다.**
        -   **상호작용**: 초대된 멤버는 '참여(ACCEPTED)' 또는 '불참(DECLINED)' 의사를 표시할 수 있으며, '참여'가 기본 상태입니다. '불참' 시, 미리 정의된 사유(예: '개인 사정', '다른 일정과 겹침')를 선택하거나 직접 입력할 수 있어, 주최자는 참여율 저조의 원인을 분석할 수 있습니다.
    3.  **참여 신청형 (RSVP)**:
        -   **로직**: 참여 인원 제한(`max_participants`)을 설정할 수 있습니다. 멤버가 '참여 신청'을 하면 `current_participants`가 1 증가하며, 이 값이 `max_participants`에 도달하면 신청은 자동으로 마감됩니다.
        -   **상호작용**: 신청은 **선착순**으로 처리되며, 마감 이후에는 신청 버튼이 비활성화됩니다. 주최자는 실시간 참여자 목록과 현황을 확인할 수 있습니다.

-   **반복 일정 생성 UI**:
    -   **시작일/종료일 DatePicker**: 사용자가 반복 일정의 범위를 명시적으로 지정합니다.
    -   **반복 패턴 선택**:
        -   **"매일" 옵션**: 시작일부터 종료일까지 매일 인스턴스 생성
        -   **"요일 선택" 옵션**: 체크박스 [월] [화] [수] [목] [금] [토] [일]로 특정 요일만 선택
    -   **저장 방식**: 백엔드는 선택된 범위와 패턴에 따라 명시적 인스턴스를 생성하여 DB에 저장
    -   **recurrence_rule 저장 형식 (JSON)**:
        ```json
        {
          "type": "WEEKLY",
          "daysOfWeek": ["MONDAY", "WEDNESDAY", "FRIDAY"]
        }
        ```
        또는
        ```json
        {
          "type": "DAILY"
        }
        ```
    -   **상세 설계**: [DD-CAL-002](calendar-design-decisions.md#dd-cal-002-반복-일정-저장-방식-및-ui-설계) 참조

-   **핵심 편의 기능 (상세 로직)**:
    -   **최적 시간 추천**: 대상자들의 **'시간표(Timetable)'**에 등록된 모든 고정 일정(강의, 개인 반복 일정)과, 그들이 이미 **'참여'하고 있는 다른 그룹 일정**을 모두 분석하여 충돌이 가장 적은 시간대를 슬롯별로 추천합니다. 사용자는 분석 대상(시간표 포함 여부, 다른 그룹 일정 포함 여부)을 토글하여 추천의 정확도를 조절할 수 있습니다.
    -   **채널 게시글 연동**: 일정 생성 시 특정 채널을 선택하면, 해당 채널에 일정을 설명하는 게시글이 자동으로 생성됩니다. 이 게시글에는 일정의 상세 정보(시간, 장소)와 함께, 일정 유형에 맞는 액션 버튼(`[참여 신청]`, `[불참 의사 전달]`)이 포함되어 멤버들의 참여를 유도합니다.

### 3.3. 장소 캘린더 및 관리

장소의 예약 현황을 보여주는 '장소 캘린더'는 **시스템의 모든 사용자에게 공개**됩니다. 또한, 별도의 `PLACE_RESERVE` 권한 없이, 장소 사용을 승인받은 그룹의 멤버라면 누구나 해당 장소를 예약할 수 있습니다.

-   **예약 가능 시간 판별 로직 (상세)**:
    1.  **1단계: 기본 규칙 확인 (Whitelist)**
        -   사용자가 특정 날짜(예: 11월 25일 월요일)의 예약 가능 시간을 조회하면, 시스템은 먼저 `PlaceAvailability` 테이블에서 해당 장소의 '월요일' 운영 규칙(예: 09:00-18:00)을 찾습니다.
        -   만약 규칙이 없으면, 해당 요일은 '예약 불가'로 즉시 처리됩니다.
        -   **PlaceAvailability는 별도 레코드 방식으로 관리**됩니다. 각 요일별 시간대가 개별 레코드로 저장됩니다.

    2.  **2단계: 예외 날짜 확인**
        -   `PlaceUnavailableDate` 테이블에서 11월 25일이 예외 날짜로 등록되어 있는지 확인합니다.
        -   예외 날짜가 등록되어 있으면 해당 날짜 전체를 '예약 불가'로 처리합니다.

    3.  **3단계: 예약 현황 확인 (Blacklist)**
        -   운영 규칙이 있고 예외 날짜가 아니라면, 시스템은 `PlaceReservation` 테이블에서 11월 25일에 이미 잡힌 모든 예약을 조회합니다. (예: 10:00-11:00, 15:00-17:00)

    4.  **4단계: 최종 결과 제시**
        -   마지막으로, 시스템은 **[기본 운영 시간]**에서 **[이미 예약된 시간]**을 제외한 최종 예약 가능 시간 슬롯 목록(`[09:00-10:00]`, `[11:00-15:00]`, `[17:00-18:00]`)을 계산하여 사용자에게 보여줍니다.

## 4. 데이터 모델 (Entity Relationship)

하이브리드 모델을 지원하기 위해 `PlaceAvailability` 엔티티와 개인 이벤트를 위한 `PersonalEvent` 엔티티를 공식적으로 추가합니다.

```
// 개인 영역
User [1:N] UserCourseTimetable [N:1] CourseTimetable [N:1] Course (-> 시간표)
User [1:N] PersonalSchedule                                    (-> 시간표)
User [1:N] PersonalEvent                                       (-> 캘린더)

// 그룹 영역
Group [1:N] GroupEvent [1:N] EventParticipant [N:1] User       (-> 그룹 캘린더 -> 개인 캘린더)
                  GroupEvent [1:N] EventException
                  GroupEvent [1:1] PlaceReservation [N:1] Place

// 장소 관리
Group (관리주체) [1:N] Place [1:N] PlaceAvailability (운영 규칙)
                          Place [1:N] PlaceUsageGroup [N:1] Group (사용그룹)
```

## 5. API 엔드포인트 계획 (v1.4)

권한 단순화에 따라 각 API의 접근 제어(권한) 요구사항이 업데이트됩니다.

-   **시간표 API (`/api/timetable`)**: 모든 기능 `isAuthenticated()`
-   **개인 캘린더 API (`/api/calendar`)**: 모든 기능 `isAuthenticated()`

-   **그룹 캘린더 API (`/api/groups/{groupId}/events`)**:
    -   `GET /`: **그룹 멤버** (`isMember()`)
    -   `POST /`: (공식) **`CALENDAR_MANAGE`** / (비공식) **그룹 멤버** (`isMember()`)
    -   `PUT /{eventId}`: (공식) **`CALENDAR_MANAGE`** / (비공식) **작성자 or `CALENDAR_MANAGE`**
    -   `DELETE /{eventId}`: (공식) **`CALENDAR_MANAGE`** / (비공식) **작성자 or `CALENDAR_MANAGE`**

-   **장소 API (`/api/places`)**:
    -   `GET /`: **인증된 모든 사용자** (장소 목록 조회)
    -   `GET /{placeId}/available-slots?date=YYYY-MM-DD`: **인증된 모든 사용자**
    -   `POST /`: **`CALENDAR_MANAGE`** (장소 등록)
    -   `PUT /{placeId}`: **`CALENDAR_MANAGE`** (장소 수정)
    -   `DELETE /{placeId}`: **`CALENDAR_MANAGE`** (장소 삭제)

-   **장소 사용 그룹 API (`/api/places/{placeId}/usage-groups`)**:
    -   `GET /`: **인증된 모든 사용자** (승인된 사용 그룹 목록 조회)
    -   `POST /`: **그룹 멤버** (`isMember()`, 사용 그룹 신청)
    -   `PUT /{usageGroupId}/approve`: **`CALENDAR_MANAGE`** (사용 그룹 승인)
    -   `PUT /{usageGroupId}/reject`: **`CALENDAR_MANAGE`** (사용 그룹 거절)

-   **장소 예약 API (`/api/places/{placeId}/reservations`)**:
    -   `GET /`: **인증된 모든 사용자** (예약 현황 조회)
    -   `POST /`: **PlaceUsageGroup APPROVED + 그룹 멤버** (예약 생성)
    -   `DELETE /{reservationId}`: **예약 작성자 or `CALENDAR_MANAGE`** (예약 취소)